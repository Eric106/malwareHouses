from dataclasses import dataclass,field
from json import loads
from os import listdir
from os.path import getmtime

@dataclass(frozen=True)
class MalwarebytesLogManager():
    log_path : str = field(init=True, default="C:/ProgramData/Malwarebytes/MBAMService/MwacDetections")
    log_items : dict = field(init=False)

    def __post_init__(self):
        self.load_logs()

    def load_logs(self):     
        log_files = [ f'{self.log_path}/{file}' for file in listdir(self.log_path)]
        log_files.sort(key=lambda path_file: getmtime(path_file))
        log_items = dict()
        for file_name in log_files:
            file = open(file_name,'r')
            file_content: list = file.readlines()[1:]
            file_content: str = "".join(file_content)
            log_items[file_name] = loads(file_content)
        object.__setattr__(self,'log_items',log_items)

    def get_inbound_ip_detections(self) -> list[str]:
        inbound_ip_detections : list = []
        for log_item in self.log_items.values():
            if log_item['threats'][0]['mainTrace']['websiteData']['isInbound']:
                ip = log_item['threats'][0]['mainTrace']['websiteData']['ip']
                if not ip in inbound_ip_detections:inbound_ip_detections.append(ip)
        return inbound_ip_detections